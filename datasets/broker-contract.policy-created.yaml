---
kind: DatasetSnapshot
version: 1
content:
  name: broker-contract.policy-created
  kind: Root
  metadata:
    - kind: SetPollingSource
      fetch:
        kind: EthereumLogs
        # Ethereum Sepolia Testnet
        chainId: 11155111
        nodeUrl: wss://sepolia.infura.io/ws/v3/441241861f624756a18462c3af944d35
        signature: |
          event PolicyCreated(
            uint64 indexed policyId,
            address indexed holder,
            address indexed insurer,
            uint holderDeposit,
            uint insurerDeposit
          )
        # Using contract deployment block to limit scanning
        filter: |
          address = X'f52bc7be133a4cb3799bfe6399bc576465f28153'
          and
          block_number >= 6432751
      read:
        kind: Parquet
      preprocess:
        kind: Sql
        engine: datafusion
        # Note many providers don't yet return `blockTimestamp` from `eth_getLogs`
        # so we fallback to the time contained within the event
        # See: https://github.com/ethereum/execution-apis/issues/295
        query: |
          select
            -- coalesce(
            --   block_timestamp,
            --   to_timestamp_seconds(cast(event.time as bigint))
            -- ) as event_time,
            block_number,
            block_hash,
            transaction_index,
            transaction_hash,
            log_index,
            event."policyId" as policy_id,
            event.holder as holder,
            event.insurer as insurer,
            cast(event."holderDeposit" as double) / pow(10.0, 18) as holder_deposit,
            cast(event."insurerDeposit" as double) / pow(10.0, 18) as insurer_deposit
          from input
      merge:
        kind: Append
